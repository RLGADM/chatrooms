<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Salon de jeu - Kensho</title>
    <meta name="description" content="Salon de jeu Kensho - Rejoignez la partie en cours !" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
      /* Custom animations and effects */
      @keyframes pulse-slow {
        0%, 100% { opacity: 0.05; }
        50% { opacity: 0.1; }
      }
      
      .animate-pulse-slow {
        animation: pulse-slow 3s ease-in-out infinite;
      }
      
      /* Glassmorphism effects */
      .glass {
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
      }
      
      /* Hover effects */
      .hover-scale:hover {
        transform: scale(1.05);
      }
      
      /* Custom scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      
      .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }
      
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
      }
      
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-slate-800 via-slate-700 to-slate-900 min-h-screen transition-all duration-1000">
    <!-- Animated Background Pattern -->
    <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width=%2260%22 height=%2260%22 viewBox=%220 0 60 60%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cg fill=%22none%22 fill-rule=%22evenodd%22%3E%3Cg fill=%22%23ffffff%22 fill-opacity=%220.05%22%3E%3Cpath d=%22m36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z%22/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')] animate-pulse-slow pointer-events-none"></div>
    
    <!-- Header -->
    <header class="relative z-10 p-6">
      <div class="flex items-center justify-between">
        <!-- Left Side -->
        <div class="flex items-center space-x-4">
          <h1 class="text-white text-3xl font-black tracking-wider" style="font-family: 'Montserrat', sans-serif;">KENSHO</h1>
          <div class="bg-white/20 glass px-4 py-2 rounded-full border border-white/30 hover:bg-white/30 transition-all duration-300">
            <span class="text-white text-sm font-semibold">Salon : <span class="text-yellow-300 font-bold" id="gameCode">{{GAME_CODE}}</span></span>
          </div>
          <button id="copyUrlBtn" class="bg-white/20 glass hover:bg-white/30 text-white px-4 py-2 rounded-full text-sm font-semibold transition-all duration-300 border border-white/30 flex items-center space-x-2 hover-scale">
            <i data-lucide="copy" class="w-4 h-4"></i>
            <span>Copier URL</span>
          </button>
          <div class="bg-white/20 glass px-4 py-2 rounded-full border border-white/30">
            <span class="text-white text-sm font-semibold">Admin : <span class="text-green-300 font-bold" id="adminName">{{ADMIN_NAME}}</span></span>
          </div>
        </div>
        
        <!-- Right Side -->
        <div class="flex items-center space-x-4">
          <button id="playersBtn" class="bg-white/20 glass hover:bg-white/30 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-300 border border-white/30 flex items-center space-x-2 hover-scale">
            <i data-lucide="users" class="w-4 h-4"></i>
            <span>Joueurs</span>
          </button>
          <button id="settingsBtn" class="bg-white/20 glass hover:bg-white/30 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-300 border border-white/30 flex items-center space-x-2 hover-scale">
            <i data-lucide="settings" class="w-4 h-4"></i>
            <span>Paramètres</span>
          </button>
          <button id="leaveBtn" class="bg-red-500/80 glass hover:bg-red-600 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-300 flex items-center space-x-2 hover-scale">
            <i data-lucide="log-out" class="w-4 h-4"></i>
            <span>Quitter</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Status Bar -->
    <div class="relative z-10 px-6 mb-6">
      <div class="max-w-7xl mx-auto">
        <div class="bg-white/10 glass rounded-2xl p-4 shadow-xl border border-white/20">
          <div class="grid grid-cols-4 gap-4 items-center">
            
            <!-- Phase de jeu -->
            <div class="col-span-1">
              <div class="bg-blue-500/20 glass rounded-xl p-3 border border-blue-300/30 text-center hover:bg-blue-500/30 transition-all duration-300">
                <div class="flex items-center justify-center mb-2">
                  <button id="phaseControlBtn" class="text-blue-300 hover:text-white transition-colors flex items-center justify-center mr-2">
                    <i data-lucide="play-circle" class="w-5 h-5"></i>
                  </button>
                  <span class="text-blue-200 text-sm font-semibold">Phase</span>
                </div>
                <h3 class="text-white font-bold text-sm" id="currentPhase">Attente début de la manche</h3>
              </div>
            </div>
            
            <!-- Temps restant (2 colonnes) -->
            <div class="col-span-2">
              <div class="bg-orange-500/20 glass rounded-xl p-3 border border-orange-300/30 hover:bg-orange-500/30 transition-all duration-300">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center">
                    <i data-lucide="timer" class="w-5 h-5 text-orange-300 mr-2"></i>
                    <span class="text-orange-200 text-sm font-semibold">Temps</span>
                  </div>
                  <h3 class="text-white font-bold text-xl" id="timerDisplay">--:--</h3>
                </div>
                
                <!-- Progress Bar -->
                <div class="relative">
                  <div class="bg-white/20 rounded-full h-3 overflow-hidden">
                    <div 
                      class="h-3 rounded-full transition-all duration-1000 bg-gradient-to-r from-green-400 to-red-500" 
                      id="progressBar"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Score -->
            <div class="col-span-1">
              <div class="bg-purple-500/20 glass rounded-xl p-3 border border-purple-300/30 text-center hover:bg-purple-500/30 transition-all duration-300">
                <div class="flex items-center justify-center mb-1">
                  <i data-lucide="trophy" class="w-5 h-5 text-purple-300 mr-2"></i>
                  <span class="text-purple-200 text-sm font-semibold">Score</span>
                </div>
                <h3 class="text-white font-bold text-lg" id="scoreDisplay">0 - 0</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Game Area -->
    <main class="relative z-10 px-6 pb-8">
      <div class="max-w-7xl mx-auto">
        <div class="grid lg:grid-cols-5 gap-6">
          
          <!-- Left Column: Équipe Rouge -->
          <div class="lg:col-span-1">
            <div class="bg-white/10 glass rounded-2xl p-6 shadow-xl border border-white/20 hover:bg-white/15 transition-all duration-300">
              <div class="text-center mb-6">
                <div class="bg-red-500/20 glass px-6 py-3 rounded-full border border-red-300/30 inline-block hover:bg-red-500/30 transition-all duration-300">
                  <h3 class="text-red-200 font-bold text-lg tracking-wide">ÉQUIPE ROUGE</h3>
                </div>
              </div>
              
              <!-- Sage -->
              <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-white/90 text-sm font-semibold flex items-center">
                    <i data-lucide="crown" class="w-4 h-4 mr-2 text-yellow-400"></i>
                    Sage
                  </h4>
                  <button class="bg-yellow-500/20 hover:bg-yellow-500/40 text-yellow-200 px-3 py-1.5 rounded-full text-xs font-semibold transition-all duration-300 border border-yellow-300/30 hover:border-yellow-300/50 hover-scale join-sage-red">
                    Rejoindre
                  </button>
                </div>
                <div class="bg-white/10 glass rounded-xl p-4 border border-white/20 opacity-50" id="redSage">
                  <div class="text-center text-white/60 text-sm py-4">
                    Aucun Sage assigné
                  </div>
                </div>
              </div>
              
              <!-- Disciples -->
              <div>
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-white/90 text-sm font-semibold flex items-center">
                    <i data-lucide="users" class="w-4 h-4 mr-2 text-blue-400"></i>
                    Disciples
                  </h4>
                  <button class="bg-blue-500/20 hover:bg-blue-500/40 text-blue-200 px-3 py-1.5 rounded-full text-xs font-semibold transition-all duration-300 border border-blue-300/30 hover:border-blue-300/50 hover-scale join-disciple-red">
                    Rejoindre
                  </button>
                </div>
                <div class="space-y-3" id="redDisciples">
                  <!-- Les disciples seront ajoutés dynamiquement -->
                </div>
              </div>
            </div>
          </div>

          <!-- Center Columns: Game Area -->
          <div class="lg:col-span-3">
            <!-- Proposal Input -->
            <div class="bg-white/10 glass rounded-2xl p-4 shadow-xl border border-white/20 mb-6 hover:bg-white/15 transition-all duration-300">
              <div class="flex space-x-3">
                <input 
                  type="text" 
                  id="proposalInput"
                  placeholder="Tapez votre réponse..."
                  class="flex-1 px-4 py-3 bg-white/20 glass border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500/50 font-semibold focus:bg-white/30 transition-all duration-300"
                />
                <button id="submitProposal" class="bg-green-500/80 glass hover:bg-green-600 text-white px-6 py-3 rounded-xl font-bold transition-all duration-300 hover-scale">
                  <i data-lucide="check" class="w-5 h-5"></i>
                </button>
              </div>
            </div>
            
            <!-- Game Area Split -->
            <div class="grid grid-cols-2 gap-6">
              
              <!-- History -->
              <div class="bg-white/10 glass rounded-2xl p-6 shadow-xl border border-white/20 h-[600px] hover:bg-white/15 transition-all duration-300">
                <h3 class="text-white font-bold text-xl mb-4 flex items-center">
                  <i data-lucide="history" class="w-6 h-6 mr-3 text-blue-400"></i>
                  Historique
                </h3>
                
                <div class="space-y-3 h-[520px] overflow-y-auto custom-scrollbar" id="gameHistory">
                  <!-- L'historique sera ajouté dynamiquement -->
                </div>
              </div>

              <!-- Game Interaction -->
              <div class="bg-white/10 glass rounded-2xl p-6 shadow-xl border border-white/20 h-[600px] flex flex-col hover:bg-white/15 transition-all duration-300">
                <h3 class="text-white font-bold text-xl mb-4 flex items-center">
                  <i data-lucide="gamepad-2" class="w-6 h-6 mr-3 text-purple-400"></i>
                  Zone de jeu
                </h3>
                
                <!-- Word Display -->
                <div class="mb-6">
                  <div class="bg-gray-500/20 glass rounded-2xl p-6 border border-gray-300/30 text-center hover:bg-gray-500/30 transition-all duration-300" id="wordDisplay">
                    <div class="flex items-center justify-center mb-3">
                      <i data-lucide="target" class="w-8 h-8 text-gray-300 mr-3"></i>
                      <span class="text-gray-200 text-lg font-semibold">En attente</span>
                    </div>
                    <h4 class="text-gray-400 font-bold text-3xl">---</h4>
                  </div>
                </div>
                
                <!-- Forbidden Words -->
                <div class="bg-white/10 glass rounded-2xl p-4 border border-white/20 mb-6 flex-1">
                  <div class="flex items-center mb-3">
                    <i data-lucide="shield-x" class="w-5 h-5 text-red-300 mr-2"></i>
                    <span class="text-white font-semibold">Mots interdits par l'équipe</span>
                  </div>
                  <div class="grid grid-cols-2 gap-2 h-full content-start" id="forbiddenWords">
                    <!-- Forbidden words will be added dynamically -->
                  </div>
                </div>
                
                <!-- Game Controls -->
                <div class="grid grid-cols-2 gap-3">
                  <button id="startButton" class="bg-green-500/20 glass hover:bg-green-500/40 text-green-200 p-4 rounded-xl font-semibold transition-all duration-300 border border-green-300/30 flex items-center justify-center space-x-2 hover-scale">
                    <i data-lucide="play" class="w-5 h-5"></i>
                    <span>Commencer</span>
                  </button>
                  <button id="pauseButton" class="bg-red-500/20 glass text-red-200 p-4 rounded-xl font-semibold border border-red-300/30 flex items-center justify-center space-x-2 opacity-50 cursor-not-allowed" disabled>
                    <i data-lucide="pause" class="w-5 h-5"></i>
                    <span>Pause</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column: Équipe Bleue -->
          <div class="lg:col-span-1">
            <div class="bg-white/10 glass rounded-2xl p-6 shadow-xl border border-white/20 hover:bg-white/15 transition-all duration-300">
              <div class="text-center mb-6">
                <div class="bg-blue-500/20 glass px-6 py-3 rounded-full border border-blue-300/30 inline-block hover:bg-blue-500/30 transition-all duration-300">
                  <h3 class="text-blue-200 font-bold text-lg tracking-wide">ÉQUIPE BLEUE</h3>
                </div>
              </div>
              
              <!-- Sage -->
              <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-white/90 text-sm font-semibold flex items-center">
                    <i data-lucide="crown" class="w-4 h-4 mr-2 text-yellow-400"></i>
                    Sage
                  </h4>
                  <button class="bg-yellow-500/20 hover:bg-yellow-500/40 text-yellow-200 px-3 py-1.5 rounded-full text-xs font-semibold transition-all duration-300 border border-yellow-300/30 hover:border-yellow-300/50 hover-scale join-sage-blue">
                    Rejoindre
                  </button>
                </div>
                <div class="bg-white/10 glass rounded-xl p-4 border border-white/20 opacity-50" id="blueSage">
                  <div class="text-center text-white/60 text-sm py-4">
                    Aucun Sage assigné
                  </div>
                </div>
              </div>
              
              <!-- Disciples -->
              <div>
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-white/90 text-sm font-semibold flex items-center">
                    <i data-lucide="users" class="w-4 h-4 mr-2 text-blue-400"></i>
                    Disciples
                  </h4>
                  <button class="bg-blue-500/20 hover:bg-blue-500/40 text-blue-200 px-3 py-1.5 rounded-full text-xs font-semibold transition-all duration-300 border border-blue-300/30 hover:border-blue-300/50 hover-scale join-disciple-blue">
                    Rejoindre
                  </button>
                </div>
                <div class="space-y-3" id="blueDisciples">
                  <!-- Les disciples seront ajoutés dynamiquement -->
                </div>
              </div>
            </div>
            
            <!-- Spectateurs -->
            <div class="bg-white/10 glass rounded-2xl p-6 shadow-xl border border-white/20 hover:bg-white/15 transition-all duration-300 mt-6">
              <div class="text-center mb-6">
                <div class="bg-gray-500/20 glass px-6 py-3 rounded-full border border-gray-300/30 inline-block hover:bg-gray-500/30 transition-all duration-300">
                  <h3 class="text-gray-200 font-bold text-lg tracking-wide">SPECTATEURS</h3>
                </div>
              </div>
              
              <div class="flex items-center justify-between mb-3">
                <h4 class="text-white/90 text-sm font-semibold flex items-center">
                  <i data-lucide="eye" class="w-4 h-4 mr-2 text-gray-400"></i>
                  Observateurs
                </h4>
                <button class="bg-gray-500/20 hover:bg-gray-500/40 text-gray-200 px-3 py-1.5 rounded-full text-xs font-semibold transition-all duration-300 border border-gray-300/30 hover:border-gray-300/50 hover-scale join-spectator">
                  Rejoindre
                </button>
              </div>
              
              <div class="space-y-3" id="spectators">
                <!-- Les spectateurs seront ajoutés dynamiquement -->
                <div class="bg-white/10 glass rounded-xl p-4 border border-white/20 opacity-50">
                  <div class="text-center text-white/60 text-sm py-2">
                    Aucun spectateur
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="relative z-10 px-6 py-4">
      <div class="max-w-7xl mx-auto text-center">
        <p class="text-white/60 text-sm">
          © 2025 Kensho – Salon de jeu en temps réel
        </p>
      </div>
    </footer>

    <!-- Players Modal -->
    <div id="playersModal" class="fixed inset-0 bg-black/50 glass z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white/95 glass rounded-3xl max-w-2xl w-full max-h-[80vh] overflow-y-auto shadow-2xl border border-white/20">
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Gestion des joueurs</h2>
            <button id="closePlayersModal" class="bg-red-500 hover:bg-red-600 text-white p-3 rounded-full transition-all duration-300 hover-scale">
              <i data-lucide="x" class="w-6 h-6"></i>
            </button>
          </div>
          
          <div class="space-y-4" id="playersModalContent">
            <!-- Les joueurs seront ajoutés dynamiquement -->
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 glass z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white/95 glass rounded-3xl max-w-4xl w-full max-h-[80vh] overflow-y-auto shadow-2xl border border-white/20">
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Paramètres de la partie</h2>
            <button id="closeSettingsModal" class="bg-red-500 hover:bg-red-600 text-white p-3 rounded-full transition-all duration-300 hover-scale">
              <i data-lucide="x" class="w-6 h-6"></i>
            </button>
          </div>
          
          <!-- Reset Button -->
          <div class="mb-6">
            <button id="resetGameBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 flex items-center space-x-2 hover-scale">
              <i data-lucide="refresh-cw" class="w-5 h-5"></i>
              <span>Réinitialiser la partie</span>
            </button>
          </div>
          
          <!-- Settings Grid -->
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Time Management -->
            <div class="bg-gray-50 rounded-2xl p-6">
              <h3 class="font-bold text-gray-800 mb-4 text-lg">Gestion du temps</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Temps phase 1 :</label>
                  <select id="phase1Time" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="30">30s</option>
                    <option value="45">45s</option>
                    <option value="60">60s</option>
                    <option value="90">90s</option>
                    <option value="120">120s</option>
                  </select>
                </div>
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Temps phase 2 :</label>
                  <select id="phase2Time" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="60">60s</option>
                    <option value="90" selected>90s</option>
                    <option value="120">120s</option>
                    <option value="150">150s</option>
                    <option value="180">180s</option>
                  </select>
                </div>
                <div>
                  <label class="block text-gray-700 font-semibold mb-2">Temps phase 3 :</label>
                  <select id="phase3Time" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="30">30s</option>
                    <option value="60">60s</option>
                    <option value="90">90s</option>
                    <option value="120" selected>120s</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Word Types -->
            <div class="bg-gray-50 rounded-2xl p-6">
              <h3 class="font-bold text-gray-800 mb-4 text-lg">Types de mots</h3>
              <div class="space-y-4">
                <label class="flex items-center space-x-3">
                  <input type="checkbox" id="veryCommon" checked class="w-5 h-5 accent-blue-600 rounded" />
                  <span class="text-gray-700 font-medium">Mots très courants</span>
                </label>
                <label class="flex items-center space-x-3">
                  <input type="checkbox" id="lessCommon" checked class="w-5 h-5 accent-blue-600 rounded" />
                  <span class="text-gray-700 font-medium">Mots moins courants</span>
                </label>
                <label class="flex items-center space-x-3">
                  <input type="checkbox" id="rarelyCommon" class="w-5 h-5 accent-blue-600 rounded" />
                  <span class="text-gray-700 font-medium">Mots rarement courants</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Validate Button -->
          <div class="mt-6 text-center">
            <button id="validateSettingsBtn" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-xl font-semibold transition-all duration-300 hover-scale">
              Valider et réinitialiser
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // Initialize Lucide icons
      lucide.createIcons();
      
      // Game state
      let gameState = {
        gameCode: '{{GAME_CODE}}',
        adminName: '{{ADMIN_NAME}}',
        currentPlayer: localStorage.getItem('kensho-player-name') || 'Joueur',
        currentPhase: 0,
        phases: [
          "Attente début de la manche",
          "Phase 1 - Choix du mot", 
          "Phase 2 - Choix des mots interdits",
          "Phase 3 - Discours du Sage"
        ],
        teams: {
          red: { sage: null, disciples: [] },
          blue: { sage: null, disciples: [] }
        },
        spectators: [],
        gameSettings: JSON.parse(localStorage.getItem('kensho-settings') || '{}'),
        timer: null,
        timeRemaining: 0,
        totalTime: 0,
        isPlaying: false,
        score: { red: 0, blue: 0 }
      };

      // Initialize game
      function initializeGame() {
        // Set game code and admin name from URL or template
        const urlParams = new URLSearchParams(window.location.search);
        const gameCodeFromUrl = urlParams.get('code') || gameState.gameCode;
        
        document.getElementById('gameCode').textContent = gameCodeFromUrl;
        document.getElementById('adminName').textContent = gameState.adminName;
        
        // Add current player to blue team disciples by default
        addPlayerToTeam('blue', 'disciple', gameState.currentPlayer, true);
        
        updatePhaseDisplay();
        setupEventListeners();
        addHistoryEntry('users', `Salon créé par ${gameState.adminName}`, 'green');
        addHistoryEntry('users', `${gameState.currentPlayer} a rejoint le salon`, 'green');
      }

      // Setup event listeners
      function setupEventListeners() {
        // Modal controls
        document.getElementById('playersBtn').addEventListener('click', () => openModal('playersModal'));
        document.getElementById('settingsBtn').addEventListener('click', () => openModal('settingsModal'));
        document.getElementById('closePlayersModal').addEventListener('click', () => closeModal('playersModal'));
        document.getElementById('closeSettingsModal').addEventListener('click', () => closeModal('settingsModal'));
        
        // Game controls
        document.getElementById('startButton').addEventListener('click', startGame);
        document.getElementById('pauseButton').addEventListener('click', pauseGame);
        document.getElementById('phaseControlBtn').addEventListener('click', handlePhaseControl);
        document.getElementById('submitProposal').addEventListener('click', submitProposal);
        document.getElementById('copyUrlBtn').addEventListener('click', copyGameUrl);
        document.getElementById('leaveBtn').addEventListener('click', leaveGame);
        
        // Team join buttons
        document.querySelectorAll('.join-sage-red').forEach(btn => 
          btn.addEventListener('click', () => joinTeam('red', 'sage'))
        );
        document.querySelectorAll('.join-sage-blue').forEach(btn => 
          btn.addEventListener('click', () => joinTeam('blue', 'sage'))
        );
        document.querySelectorAll('.join-disciple-red').forEach(btn => 
          btn.addEventListener('click', () => joinTeam('red', 'disciple'))
        );
        document.querySelectorAll('.join-disciple-blue').forEach(btn => 
          btn.addEventListener('click', () => joinTeam('blue', 'disciple'))
        );
        document.querySelectorAll('.join-spectator').forEach(btn => 
          btn.addEventListener('click', () => joinSpectator())
        );

        // Enter key for proposal
        document.getElementById('proposalInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') submitProposal();
        });
      }

      // Modal functions
      function openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
        if (modalId === 'playersModal') updatePlayersModal();
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
      }

      // Team management
      function joinTeam(team, role) {
        if (role === 'sage' && gameState.teams[team].sage) {
          alert('Il y a déjà un Sage dans cette équipe !');
          return;
        }
        
        // Remove player from current team
        removePlayerFromAllTeams(gameState.currentPlayer);
        removePlayerFromSpectators(gameState.currentPlayer);
        
        // Add to new team
        addPlayerToTeam(team, role, gameState.currentPlayer, true);
        
        const teamName = team === 'red' ? 'Rouge' : 'Bleue';
        const roleName = role === 'sage' ? 'Sage' : 'Disciple';
        addHistoryEntry('users', `${gameState.currentPlayer} est devenu ${roleName} de l'équipe ${teamName}`, 'blue');
      }

      function joinSpectator() {
        // Remove player from current team
        removePlayerFromAllTeams(gameState.currentPlayer);
        removePlayerFromSpectators(gameState.currentPlayer);
        
        // Add to spectators
        gameState.spectators.push({ name: gameState.currentPlayer, isCurrentPlayer: true });
        updateSpectatorsDisplay();
        
        addHistoryEntry('users', `${gameState.currentPlayer} est devenu spectateur`, 'blue');
      }
      function addPlayerToTeam(team, role, playerName, isCurrentPlayer = false) {
        if (role === 'sage') {
          gameState.teams[team].sage = { name: playerName, isCurrentPlayer };
          updateSageDisplay(team);
        } else {
          gameState.teams[team].disciples.push({ name: playerName, isCurrentPlayer });
          updateDisciplesDisplay(team);
        }
      }

      function removePlayerFromAllTeams(playerName) {
        // Remove from sage positions
        if (gameState.teams.red.sage?.name === playerName) {
          gameState.teams.red.sage = null;
          updateSageDisplay('red');
        }
        if (gameState.teams.blue.sage?.name === playerName) {
          gameState.teams.blue.sage = null;
          updateSageDisplay('blue');
        }
        
        // Remove from disciples
        gameState.teams.red.disciples = gameState.teams.red.disciples.filter(d => d.name !== playerName);
        gameState.teams.blue.disciples = gameState.teams.blue.disciples.filter(d => d.name !== playerName);
        updateDisciplesDisplay('red');
        updateDisciplesDisplay('blue');
      }

      function removePlayerFromSpectators(playerName) {
        gameState.spectators = gameState.spectators.filter(s => s.name !== playerName);
        updateSpectatorsDisplay();
      }
      function updateSageDisplay(team) {
        const sageElement = document.getElementById(`${team}Sage`);
        const sage = gameState.teams[team].sage;
        
        if (sage) {
          const bgColor = team === 'red' ? 'bg-red-500/20 border-red-300/30' : 'bg-blue-500/20 border-blue-300/30';
          const highlight = sage.isCurrentPlayer ? 'ring-2 ring-yellow-400/50' : '';
          
          sageElement.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-${team === 'red' ? 'red' : 'blue'}-500 rounded-full flex items-center justify-center shadow-lg">
                  <span class="text-white font-bold text-lg">${sage.name.charAt(0).toUpperCase()}</span>
                </div>
                <div>
                  <p class="text-white font-semibold">${sage.name}</p>
                  <p class="text-${team === 'red' ? 'red' : 'blue'}-200 text-xs">Guide spirituel</p>
                </div>
              </div>
              <i data-lucide="crown" class="w-5 h-5 text-yellow-400"></i>
            </div>
          `;
          sageElement.className = `${bgColor} glass rounded-xl p-4 border transition-all duration-300 ${highlight}`;
          sageElement.style.opacity = '1';
        } else {
          sageElement.innerHTML = '<div class="text-center text-white/60 text-sm py-4">Aucun Sage assigné</div>';
          sageElement.className = 'bg-white/10 glass rounded-xl p-4 border border-white/20';
          sageElement.style.opacity = '0.5';
        }
        
        lucide.createIcons();
      }

      function updateDisciplesDisplay(team) {
        const disciplesElement = document.getElementById(`${team}Disciples`);
        const disciples = gameState.teams[team].disciples;
        
        disciplesElement.innerHTML = '';
        
        disciples.forEach(disciple => {
          const highlight = disciple.isCurrentPlayer ? 'ring-2 ring-blue-400/50' : '';
          const discipleDiv = document.createElement('div');
          discipleDiv.className = `bg-white/10 glass rounded-xl p-4 border border-white/20 hover:bg-white/15 transition-all duration-300 ${highlight}`;
          discipleDiv.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center">
                  <span class="text-white font-bold">${disciple.name.charAt(0).toUpperCase()}</span>
                </div>
                <div>
                  <p class="text-white font-semibold">${disciple.name}</p>
                  <p class="text-white/60 text-xs">${disciple.isCurrentPlayer ? 'Vous' : 'Apprenant'}</p>
                </div>
              </div>
              <i data-lucide="user" class="w-4 h-4 text-green-400"></i>
            </div>
          `;
          disciplesElement.appendChild(discipleDiv);
        });
        
        lucide.createIcons();
      }

      // Game phase management
      function updatePhaseDisplay() {
        document.getElementById('currentPhase').textContent = gameState.phases[gameState.currentPhase];
        updatePhaseControlButton();
      }

      function updatePhaseControlButton() {
        const phaseBtn = document.getElementById('phaseControlBtn');
        const icon = phaseBtn.querySelector('i');
        
        if (gameState.timer && gameState.currentPhase > 0) {
          // Phase en cours - afficher pause
          icon.setAttribute('data-lucide', 'pause-circle');
          phaseBtn.title = 'Mettre en pause';
        } else {
          // Phase en attente ou arrêtée - afficher play
          icon.setAttribute('data-lucide', 'play-circle');
          phaseBtn.title = gameState.currentPhase === 0 ? 'Lancer la partie' : 'Reprendre';
        }
        
        lucide.createIcons();
      }

      function handlePhaseControl() {
        if (gameState.timer && gameState.currentPhase > 0) {
          // Pause la phase en cours
          pauseGame();
        } else if (gameState.currentPhase === 0) {
          // Lance la partie
          startGame();
        } else {
          // Reprend la phase
          resumeGame();
        }
        updatePhaseControlButton();
      }

      function resumeGame() {
        if (gameState.timeRemaining > 0) {
          startTimer(gameState.timeRemaining);
          addHistoryEntry('play', 'Jeu repris', 'green');
        }
      }

      function startGame() {
        if (gameState.currentPhase === 0) {
          gameState.currentPhase = 1;
          gameState.isPlaying = true;
          updatePhaseDisplay();
          addHistoryEntry('play', 'Début de la Phase 1 - Choix du mot', 'yellow');
          
          // Start timer for phase 1
          startTimer(gameState.gameSettings.firstPhaseTime || 30);
          updatePhaseControlButton();
        }
      }

      function pauseGame() {
        if (gameState.timer) {
          clearInterval(gameState.timer);
          gameState.timer = null;
          addHistoryEntry('pause', 'Jeu mis en pause', 'orange');
          updatePhaseControlButton();
        }
      }

      function startTimer(duration) {
        gameState.timeRemaining = duration;
        gameState.totalTime = duration;
        
        gameState.timer = setInterval(() => {
          updateTimerDisplay();
          gameState.timeRemaining--;
          
          if (gameState.timeRemaining < 0) {
            clearInterval(gameState.timer);
            gameState.timer = null;
            nextPhase();
          }
        }, 1000);
      }

      function updateTimerDisplay() {
        const minutes = Math.floor(gameState.timeRemaining / 60);
        const seconds = gameState.timeRemaining % 60;
        document.getElementById('timerDisplay').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        const progress = gameState.totalTime > 0 ? ((gameState.totalTime - gameState.timeRemaining) / gameState.totalTime) * 100 : 0;
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = `${progress}%`;
        
        // Change color based on progress
        if (progress < 50) {
          progressBar.style.background = 'linear-gradient(to right, #10b981, #22c55e)';
        } else if (progress < 80) {
          progressBar.style.background = 'linear-gradient(to right, #f59e0b, #f97316)';
        } else {
          progressBar.style.background = 'linear-gradient(to right, #ef4444, #dc2626)';
        }
      }

      function nextPhase() {
        gameState.currentPhase = Math.min(gameState.currentPhase + 1, 3);
        updatePhaseDisplay();
        
        if (gameState.currentPhase <= 3) {
          addHistoryEntry('play', `Début de la ${gameState.phases[gameState.currentPhase]}`, 'yellow');
          
          // Start timer for next phase
          const phaseTimes = [0, 30, 90, 120]; // Default times
          startTimer(phaseTimes[gameState.currentPhase]);
          updatePhaseControlButton();
        }
      }

      // History management
      function addHistoryEntry(type, message, color) {
        const historyElement = document.getElementById('gameHistory');
        const entry = document.createElement('div');
        entry.className = 'bg-white/10 glass rounded-xl p-3 border border-white/20 hover:bg-white/20 transition-all duration-300';
        
        const icons = {
          users: 'users',
          play: 'play',
          pause: 'pause',
          check: 'check',
          x: 'x',
          message: 'message-square'
        };
        
        entry.innerHTML = `
          <div class="flex items-start space-x-3">
            <div class="w-6 h-6 bg-${color}-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
              <i data-lucide="${icons[type] || 'circle'}" class="w-3 h-3 text-white"></i>
            </div>
            <div class="flex-1">
              <p class="text-white text-sm font-medium">${message}</p>
              <p class="text-white/60 text-xs mt-1">
                ${new Date().toLocaleTimeString()}
              </p>
            </div>
          </div>
        `;
        
        historyElement.insertBefore(entry, historyElement.firstChild);
        lucide.createIcons();
      }

      // Game actions
      function submitProposal() {
        const input = document.getElementById('proposalInput');
        const proposal = input.value.trim();
        
        if (proposal) {
          addHistoryEntry('message', `${gameState.currentPlayer} a proposé "${proposal}"`, 'blue');
          input.value = '';
        }
      }

      function copyGameUrl() {
        const gameUrl = `${window.location.origin}${window.location.pathname}?code=${gameState.gameCode}`;
        navigator.clipboard.writeText(gameUrl).then(() => {
          addHistoryEntry('check', 'URL copiée dans le presse-papiers', 'green');
        });
      }

      function leaveGame() {
        if (confirm('Êtes-vous sûr de vouloir quitter le salon ?')) {
          window.location.href = '/';
        }
      }

      function updatePlayersModal() {
        const content = document.getElementById('playersModalContent');
        content.innerHTML = '';
        
        // Add all players from both teams
        const allPlayers = [
          ...gameState.teams.red.disciples.map(p => ({...p, team: 'Rouge', role: 'Disciple'})),
          ...gameState.teams.blue.disciples.map(p => ({...p, team: 'Bleue', role: 'Disciple'}))
        ];
        
        if (gameState.teams.red.sage) {
          allPlayers.push({...gameState.teams.red.sage, team: 'Rouge', role: 'Sage'});
        }
        if (gameState.teams.blue.sage) {
          allPlayers.push({...gameState.teams.blue.sage, team: 'Bleue', role: 'Sage'});
        }
        
        allPlayers.forEach(player => {
          const playerDiv = document.createElement('div');
          const bgClass = player.isCurrentPlayer ? 'bg-blue-50 border-2 border-blue-300' : 'bg-gray-50';
          playerDiv.className = `${bgClass} rounded-xl p-4 flex items-center justify-between`;
          playerDiv.innerHTML = `
            <div class="flex items-center space-x-3">
              <div class="w-12 h-12 bg-${player.team === 'Rouge' ? 'red' : 'blue'}-500 rounded-full flex items-center justify-center">
                <span class="text-white font-bold text-lg">${player.name.charAt(0).toUpperCase()}</span>
              </div>
              <div>
                <p class="font-semibold text-gray-800">${player.name}${player.isCurrentPlayer ? ' (Vous)' : ''}</p>
                <p class="text-gray-600 text-sm">Équipe ${player.team} - ${player.role}</p>
              </div>
            </div>
          `;
          content.appendChild(playerDiv);
        });
      }

      // Initialize the game when page loads
      document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
  </body>
</html>